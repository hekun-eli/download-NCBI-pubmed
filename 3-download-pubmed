import os
import time
import threading
from queue import Queue
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager
from tqdm import tqdm   # ç”¨äºè¿›åº¦æ¡

# ==============================
# åŸºç¡€é…ç½®
# ==============================

link_file = "/Users/hekun/Downloads/link.txt"
save_dir = "/Users/hekun/Downloads/mcr-pcnR"
failed_file = os.path.join(save_dir, "failed_links.txt")

os.makedirs(save_dir, exist_ok=True)

# æ¸…ç©ºå¤±è´¥è®°å½•æ–‡ä»¶
with open(failed_file, "w") as ff:
    pass

# ä¸ºå¤šçº¿ç¨‹åˆ›å»ºçš„ Queue
task_queue = Queue()

# è¯»å–é“¾æ¥
with open(link_file, "r") as f:
    links = [line.strip() for line in f if line.strip()]

total = len(links)
for url in links:
    task_queue.put(url)

# å…¨å±€é”ç”¨äºæ‰“å°
print_lock = threading.Lock()

# ==============================
# åˆ›å»º webdriverï¼ˆæ¯çº¿ç¨‹ç‹¬ç«‹ï¼‰
# ==============================
def create_driver():
    chrome_options = Options()
    prefs = {
        "plugins.always_open_pdf_externally": True,
        "download.default_directory": save_dir,
        "download.prompt_for_download": False,
    }
    chrome_options.add_experimental_option("prefs", prefs)
    chrome_options.add_argument("--headless=new")
    chrome_options.add_argument("--disable-gpu")

    driver = webdriver.Chrome(
        service=Service(ChromeDriverManager().install()),
        options=chrome_options
    )
    return driver


# ==============================
# ä¸‹è½½ä»»åŠ¡
# ==============================
def worker(progress_bar):
    driver = create_driver()

    while not task_queue.empty():
        url = task_queue.get()

        # æ‰“å°ä¿¡æ¯ï¼ˆåŠ é”é¿å…å¤šçº¿ç¨‹å†²çªï¼‰
        with print_lock:
            short_url = url if len(url) < 80 else url[:80] + "..."
            print(f"\nğŸ“¥ å¼€å§‹å¤„ç†: {short_url}")
            print("â³ æœ¬æ¡çŠ¶æ€: æ­£åœ¨ä¸‹è½½ä¸­...")

        try:
            driver.get(url)    # âœ… å®Œå…¨ä¸æ”¹åŠ¨
            time.sleep(5)      # âœ… å®Œå…¨ä¸æ”¹åŠ¨
            time.sleep(8)      # âœ… å®Œå…¨ä¸æ”¹åŠ¨

        except Exception as e:
            with print_lock:
                print(f"âŒ æœ¬æ¡çŠ¶æ€: ä¸‹è½½å¤±è´¥ -> {e}")
                with open(failed_file, "a") as ff:
                    ff.write(url + "\n")
        else:
            with print_lock:
                print("âœ… æœ¬æ¡çŠ¶æ€: ä¸‹è½½å®Œæˆ")
        finally:
            time.sleep(3)      # âœ… å®Œå…¨ä¸æ”¹åŠ¨
            progress_bar.update(1)

    driver.quit()


# ==============================
# å¯åŠ¨ 3 ä¸ªçº¿ç¨‹
# ==============================
print(f"ğŸ“„ å…± {total} æ¡é“¾æ¥ï¼Œä½¿ç”¨ 3 ä¸ªçº¿ç¨‹ä¸‹è½½...\n")

threads = []
with tqdm(total=total, desc="æ€»ä½“è¿›åº¦", ncols=90) as pbar:
    for _ in range(3):  # âœ… å›ºå®š 3 çº¿ç¨‹
        t = threading.Thread(target=worker, args=(pbar,))
        t.start()
        threads.append(t)

    for t in threads:
        t.join()

print("\nğŸ‰ å…¨éƒ¨ä»»åŠ¡å®Œæˆï¼PDF ä¿å­˜åœ¨:", save_dir)
print(f"âš ï¸ ä¸‹è½½å¤±è´¥é“¾æ¥å·²è®°å½•åœ¨: {failed_file}")
